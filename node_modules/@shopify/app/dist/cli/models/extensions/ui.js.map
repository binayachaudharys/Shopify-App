{"version":3,"file":"ui.js","sourceRoot":"","sources":["../../../../src/cli/models/extensions/ui.ts"],"names":[],"mappings":"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","sourcesContent":["import {BaseConfigContents, ZodSchemaType} from './schemas.js'\nimport {allUISpecifications} from './specifications.js'\nimport {ExtensionCategory, GenericSpecification, UIExtension} from '../app/extensions.js'\nimport {blocks, defualtExtensionFlavors} from '../../constants.js'\nimport {id, path, api, output, environment, string} from '@shopify/cli-kit'\nimport {ok, Result} from '@shopify/cli-kit/node/result'\n\n/**\n * Extension specification with all the needed properties and methods to load an extension.\n */\nexport interface UIExtensionSpec<TConfiguration extends BaseConfigContents = BaseConfigContents>\n  extends GenericSpecification {\n  identifier: string\n  externalIdentifier: string\n  externalName: string\n  partnersWebIdentifier: string\n  surface: string\n  showInCLIHelp: boolean\n  singleEntryPath: boolean\n  registrationLimit: number\n  supportedFlavors: {name: string; value: string}[]\n  gated: boolean\n  helpURL?: string\n  dependency?: {name: string; version: string}\n  templatePath?: string\n  graphQLType?: string\n  schema: ZodSchemaType<TConfiguration>\n  getBundleExtensionStdinContent?: (config: TConfiguration) => string\n  deployConfig?: (config: TConfiguration, directory: string) => Promise<{[key: string]: unknown}>\n  validate?: (config: TConfiguration, directory: string) => Promise<Result<unknown, string>>\n  preDeployValidation?: (config: TConfiguration) => Promise<void>\n  resourceUrl?: (config: TConfiguration) => string\n  category: () => ExtensionCategory\n  previewMessage?: (\n    host: string,\n    uuid: string,\n    config: TConfiguration,\n    storeFqdn: string,\n  ) => output.TokenizedString | undefined\n  shouldFetchCartUrl?(config: TConfiguration): boolean\n  hasExtensionPointTarget?(config: TConfiguration, target: string): boolean\n}\n\n/**\n * Class that represents an instance of a local extension\n * Before creating this class we've validated that:\n * - There is a spec for this type of extension\n * - The Schema for that spec is followed by the extension config toml file\n * - We were able to find an entry point file for that extension\n *\n * It supports extension points, making this Class compatible with both new ui-extension\n * and legacy extension types. Extension points are optional and this class will handle them if present.\n *\n * This class holds the public interface to interact with extensions\n */\nexport class UIExtensionInstance<TConfiguration extends BaseConfigContents = BaseConfigContents>\n  implements UIExtension<TConfiguration>\n{\n  entrySourceFilePath: string\n  outputBundlePath: string\n  devUUID: string\n  localIdentifier: string\n  idEnvironmentVariableName: string\n  directory: string\n  configuration: TConfiguration\n  configurationPath: string\n\n  private specification: UIExtensionSpec\n  private remoteSpecification?: api.graphql.RemoteSpecification\n\n  get graphQLType() {\n    return (this.specification.graphQLType ?? this.specification.identifier).toUpperCase()\n  }\n\n  get identifier() {\n    return this.specification.identifier\n  }\n\n  get type() {\n    return this.specification.identifier\n  }\n\n  get humanName() {\n    return this.remoteSpecification?.externalName ?? this.specification.externalName\n  }\n\n  get name() {\n    return this.configuration.name\n  }\n\n  get dependency() {\n    return this.specification.dependency\n  }\n\n  get externalType() {\n    return this.remoteSpecification?.externalIdentifier ?? this.specification.externalIdentifier\n  }\n\n  get surface() {\n    return this.specification.surface\n  }\n\n  constructor(options: {\n    configuration: TConfiguration\n    configurationPath: string\n    entryPath: string\n    directory: string\n    specification: UIExtensionSpec\n    remoteSpecification?: api.graphql.RemoteSpecification\n  }) {\n    this.configuration = options.configuration\n    this.configurationPath = options.configurationPath\n    this.entrySourceFilePath = options.entryPath\n    this.directory = options.directory\n    this.specification = options.specification\n    this.remoteSpecification = options.remoteSpecification\n    this.outputBundlePath = path.join(options.directory, 'dist/main.js')\n    this.devUUID = `dev-${id.generateRandomUUID()}`\n    this.localIdentifier = path.basename(options.directory)\n    this.idEnvironmentVariableName = `SHOPIFY_${string.constantize(path.basename(this.directory))}_ID`\n  }\n\n  deployConfig(): Promise<{[key: string]: unknown}> {\n    return this.specification.deployConfig?.(this.configuration, this.directory) ?? Promise.resolve({})\n  }\n\n  validate() {\n    if (!this.specification.validate) return Promise.resolve(ok(undefined))\n    return this.specification.validate(this.configuration, this.directory)\n  }\n\n  preDeployValidation() {\n    if (!this.specification.preDeployValidation) return Promise.resolve()\n    return this.specification.preDeployValidation(this.configuration)\n  }\n\n  async publishURL(options: {orgId: string; appId: string; extensionId?: string}) {\n    const partnersFqdn = await environment.fqdn.partners()\n    const parnersPath = this.specification.partnersWebIdentifier\n    return `https://${partnersFqdn}/${options.orgId}/apps/${options.appId}/extensions/${parnersPath}/${options.extensionId}`\n  }\n\n  previewMessage(url: string, storeFqdn: string) {\n    const heading = output.token.heading(`${this.name} (${this.humanName})`)\n    let message = output.content`Preview link: ${url}/extensions/${this.devUUID}`\n\n    if (this.specification.previewMessage) {\n      const customMessage = this.specification.previewMessage(url, this.devUUID, this.configuration, storeFqdn)\n      if (!customMessage) return\n      message = customMessage\n    }\n\n    return output.content`${heading}\\n${message.value}\\n`\n  }\n\n  getBundleExtensionStdinContent() {\n    if (this.specification.getBundleExtensionStdinContent) {\n      return this.specification.getBundleExtensionStdinContent(this.configuration)\n    }\n    const relativeImportPath = this.entrySourceFilePath?.replace(this.directory, '')\n    return `import '.${relativeImportPath}';`\n  }\n\n  shouldFetchCartUrl(): boolean {\n    return this.specification.shouldFetchCartUrl?.(this.configuration) || false\n  }\n\n  hasExtensionPointTarget(target: string): boolean {\n    return this.specification.hasExtensionPointTarget?.(this.configuration, target) || false\n  }\n}\n\n/**\n * Find the registered spececification for a given extension type\n */\nexport async function uiSpecForType(type: string): Promise<UIExtensionSpec | undefined> {\n  const allSpecs = await allUISpecifications()\n  return allSpecs.find((spec) => spec.identifier === type || spec.externalIdentifier === type)\n}\n\n// PENDING: Fetch remote specs\nfunction remoteSpecForType(type: string): api.graphql.RemoteSpecification | undefined {\n  return undefined\n}\n\nexport function createUIExtensionSpec<TConfiguration extends BaseConfigContents = BaseConfigContents>(spec: {\n  identifier: string\n  externalIdentifier: string\n  partnersWebIdentifier: string\n  surface: string\n  externalName: string\n  helpURL?: string\n  supportedFlavors?: {name: string; value: string}[]\n  showInCLIHelp?: boolean\n  dependency?: {name: string; version: string}\n  templatePath?: string\n  graphQLType?: string\n  singleEntryPath?: boolean\n  schema: ZodSchemaType<TConfiguration>\n  getBundleExtensionStdinContent?: (config: TConfiguration) => string\n  validate?: (config: TConfiguration, directory: string) => Promise<Result<unknown, string>>\n  deployConfig?: (config: TConfiguration, directory: string) => Promise<{[key: string]: unknown}>\n  preDeployValidation?: (config: TConfiguration) => Promise<void>\n  previewMessage?: (\n    host: string,\n    uuid: string,\n    config: TConfiguration,\n    storeFqdn: string,\n  ) => output.TokenizedString | undefined\n  shouldFetchCartUrl?(config: TConfiguration): boolean\n  hasExtensionPointTarget?(config: TConfiguration, target: string): boolean\n}): UIExtensionSpec<TConfiguration> {\n  const defaults = {\n    showInCLIHelp: true,\n    singleEntryPath: true,\n    gated: false,\n    registrationLimit: blocks.extensions.defaultRegistrationLimit,\n    supportedFlavors: defualtExtensionFlavors,\n    category: (): ExtensionCategory => (spec.identifier === 'theme' ? 'theme' : 'ui'),\n  }\n  return {...defaults, ...spec}\n}\n"]}